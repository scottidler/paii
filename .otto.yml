otto:
  api: 1
  tasks: [ci]
  envs:
    VERSION: "$(git describe --tags --always --dirty 2>/dev/null || echo 'dev')"

tasks:
  # Whitespace linting
  lint:
    help: "Run whitespace linting"
    bash: |
      whitespace -r

  # Code quality checks
  check:
    help: "Run all quality checks (compile, clippy, format)"
    bash: |
      echo "=== Checking compilation ==="
      cargo check --all-targets --all-features
      echo ""
      echo "=== Running Clippy ==="
      cargo clippy --all-targets --all-features -- -D warnings
      echo ""
      echo "=== Checking format ==="
      cargo fmt --all --check
      echo ""
      echo "âœ… All checks passed!"

  # Run tests
  test:
    help: "Run all tests"
    bash: |
      cargo test --all-features

  # Code coverage with llvm-cov
  cov:
    help: "Run tests with coverage via llvm-cov (use --fail-under N for threshold)"
    params:
      --fail-under:
        default: "0"
        help: "Minimum line coverage percentage (0 = no threshold)"
    bash: |
      echo "ğŸ§ª Running tests with coverage..."
      echo ""

      # Run tests with summary output (text format includes TOTAL line)
      OUTPUT=$(cargo llvm-cov --all-features 2>&1)

      # Generate HTML report (uses cached results, fast)
      cargo llvm-cov --all-features --html --no-run -q 2>/dev/null || true

      # Show test results (just the summary line)
      echo "$OUTPUT" | grep "^test result:" || true
      echo ""

      # Extract the TOTAL line and parse coverage
      TOTAL_LINE=$(echo "$OUTPUT" | grep "^TOTAL" || echo "")
      if [ -n "$TOTAL_LINE" ]; then
        # Get the last percentage (line coverage) and second percentage (function coverage)
        LINE_COV=$(echo "$TOTAL_LINE" | awk '{for(i=NF;i>=1;i--) if($i ~ /^[0-9.]+%$/) {print $i; exit}}')
        FUNC_COV=$(echo "$TOTAL_LINE" | awk '{count=0; for(i=1;i<=NF;i++) if($i ~ /^[0-9.]+%$/) {count++; if(count==2) print $i}}')

        echo "ğŸ“Š Coverage Summary:"
        echo "   Lines:     $LINE_COV"
        echo "   Functions: $FUNC_COV"
        echo ""

        # Check threshold if specified
        if [ "${fail_under}" != "0" ]; then
          COV_NUM=$(echo "$LINE_COV" | tr -d '%')
          if [ -n "$COV_NUM" ] && [ "$(echo "$COV_NUM >= $fail_under" | bc -l 2>/dev/null || echo 0)" -eq 1 ]; then
            echo "âœ… Coverage meets ${fail_under}% threshold"
          else
            echo "âŒ Coverage $LINE_COV is below ${fail_under}% threshold"
            echo "ğŸ“„ Full report: target/llvm-cov/html/index.html"
            exit 1
          fi
        fi
      fi

      echo "ğŸ“„ Full report: target/llvm-cov/html/index.html"

  # Full CI pipeline
  ci:
    help: "Full CI pipeline (lint + check + test in parallel)"
    before: [lint, check, test]
    bash: |
      echo "âœ… All CI checks passed!"

  # Build release binary
  build:
    help: "Build release binary"
    bash: |
      cargo build --release
      echo "âœ… Release build complete"

  # Clean build artifacts
  clean:
    help: "Clean build artifacts"
    bash: |
      cargo clean
      echo "âœ… Build artifacts cleaned"

  # Install locally
  install:
    help: "Install binary locally via cargo"
    bash: |
      cargo install --path .
      echo "âœ… Binary installed to ~/.cargo/bin"
